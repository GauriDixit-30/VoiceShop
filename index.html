<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceShop - AI-Powered Shopping List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --card-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        html {
            height: 100%;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            background-image: linear-gradient(to bottom, #f8fafc, #eef2f9);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .main-container { max-width: 1200px; margin: 2rem auto; padding: 1rem; flex-grow: 1; }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        .speak-button {
            transition: all 0.3s ease;
            background: linear-gradient(to right, #4f46e5, #7c3aed);
        }
        .speak-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px -5px rgb(79 70 229 / 0.4);
        }
        .speak-button.is-listening { animation: pulse-glow 1.5s infinite ease-in-out; }
        .listening-indicator span { display: inline-block; width: 10px; height: 10px; margin: 0 4px; background-color: #ffffff; border-radius: 50%; animation: pulse-indicator 1.4s infinite ease-in-out both; }
        .listening-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .listening-indicator span:nth-child(2) { animation-delay: -0.16s; }
        .footer { background-color: transparent; color: #64748b; }
        .is-thinking { cursor: wait; }
        .is-thinking button, .is-thinking select, .is-thinking .remove-item-btn { pointer-events: none; opacity: 0.8; }
        .shopping-list-item { transition: all 0.3s ease-out; }
        .shopping-list-item.completed label { text-decoration: line-through; color: #9ca3af; }
        .shopping-list-item.completed .item-name { color: #9ca3af; }
        
        .custom-checkbox {
            -webkit-appearance: none; appearance: none; background-color: #fff; margin: 0; font: inherit; color: currentColor; width: 1.15em; height: 1.15em; border: 0.15em solid #cbd5e1; border-radius: 0.25rem; transform: translateY(-0.075em);
            display: grid; place-content: center; cursor: pointer; transition: all 0.2s ease;
        }
        .custom-checkbox::before { content: ""; width: 0.65em; height: 0.65em; transform: scale(0); transition: 120ms transform ease-in-out; box-shadow: inset 1em 1em #4f46e5; transform-origin: bottom left; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%); }
        .custom-checkbox:checked::before { transform: scale(1); }
        .custom-checkbox:checked { border-color: #4f46e5; background-color: #e0e7ff; }
        .custom-checkbox:focus { outline: 2px solid #c7d2fe; }

        @keyframes pulse-indicator { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        @keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 rgb(99 102 241 / 0.5); } 70% { box-shadow: 0 0 0 12px rgb(99 102 241 / 0); } 100% { box-shadow: 0 0 0 0 rgb(99 102 241 / 0); } }
        .animate-add-item { animation: fadeInSlideUp 0.4s ease-out forwards; }
        @keyframes fadeInSlideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .animate-remove-item { animation: fadeOutShrink 0.3s ease-in forwards; }
        @keyframes fadeOutShrink { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.9); height: 0; padding: 0; margin: 0; border: 0;} }
        .spinner { width: 20px; height: 20px; border: 3px solid #c7d2fe; border-top: 3px solid #6366f1; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Modal Styles */
        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .modal.is-open { opacity: 1; visibility: visible; }
        .modal.is-open .modal-content { transform: translateY(0) scale(1); }
        
        /* Custom Scrollbar for Shopping List */
        #shopping-list-container::-webkit-scrollbar { width: 8px; }
        #shopping-list-container::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        #shopping-list-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        #shopping-list-container::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50">

    <header class="bg-white/80 shadow-sm sticky top-0 z-10 backdrop-blur-md">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-600"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line></svg>
                <h1 class="text-2xl font-bold text-gray-800">VoiceShop</h1>
            </div>
            <div class="hidden md:flex space-x-8 text-gray-600 font-medium">
                <a href="#" id="features-link" class="hover:text-indigo-600 transition-colors">Features</a>
                <a href="#" id="how-it-works-link" class="hover:text-indigo-600 transition-colors">How It Works</a>
                <a href="#" id="faq-link" class="hover:text-indigo-600 transition-colors">FAQ</a>
            </div>
        </nav>
    </header>

    <main class="main-container">
        
        <section id="voice-controller" class="card bg-indigo-600 text-white text-center overflow-hidden relative mb-6">
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-indigo-500 rounded-full opacity-50"></div>
            <div class="absolute -bottom-16 -left-8 w-40 h-40 bg-purple-500 rounded-full opacity-40"></div>
            <div class="relative z-10">
                <h2 class="text-3xl font-extrabold mb-2">Shop with Your Voice</h2>
                <p class="text-indigo-200 mb-6 max-w-xl mx-auto">The future of shopping is here. Just speak to add items, manage your list, and get smart suggestions.</p>
                <button id="speak-btn" class="speak-button text-white font-bold py-3 px-8 rounded-full shadow-lg">
                    Click to Speak
                </button>
                <div id="listening-indicator" class="listening-indicator hidden mt-1">
                    <span></span><span></span><span></span>
                </div>
                <div id="status-display" class="mt-4 text-indigo-100 h-6 flex items-center justify-center space-x-2">
                    <div id="spinner" class="spinner hidden"></div>
                    <p id="transcript"></p>
                </div>
                <p id="error-message" class="mt-2 text-red-300"></p>
            </div>
        </section>

        <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
            <section id="shopping-list-card" class="card md:col-span-3 flex flex-col !mb-0">
                <div class="flex justify-between items-center mb-4 flex-shrink-0">
                    <h3 class="text-xl font-bold text-gray-800">Your Shopping List</h3>
                    <button id="clear-btn" class="hidden bg-red-100 hover:bg-red-200 text-red-700 font-semibold py-2 px-4 rounded-lg transition-colors text-sm">Clear All</button>
                </div>
                <div id="shopping-list-container" class="flex-grow relative overflow-y-auto pr-2">
                    <div id="empty-list-msg" class="absolute inset-0 flex flex-col items-center justify-center text-gray-500">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">Your list is empty</h3>
                        <p class="mt-1 text-sm text-gray-500">Try saying "add milk".</p>
                    </div>
                    <ul id="shopping-list" class="space-y-4"></ul>
                </div>
            </section>
            
            <div class="md:col-span-2 flex flex-col space-y-6">
                <section id="smart-suggestions" class="card !mb-0 flex-1 flex flex-col">
                     <div class="flex items-center space-x-3 mb-2">
                         <div class="bg-yellow-100 p-2 rounded-full">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                         </div>
                         <h3 class="text-lg font-semibold text-gray-700">Smart Suggestions</h3>
                     </div>
                     <p id="suggestions-title" class="text-gray-500 mt-2 text-sm flex-shrink-0">Add an item to see AI recommendations!</p>
                     <div id="suggestions-container" class="mt-4 flex flex-wrap gap-2 flex-grow content-start"></div>
                </section>

                <section id="settings-commands" class="card !mb-0">
                     <div class="grid grid-cols-2 gap-6">
                         <div>
                             <h3 class="text-lg font-semibold text-gray-700 mb-3">Language</h3>
                             <select id="language-select" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 text-sm">
                                 <option value="en-US" data-lang-name="English">English (US)</option>
                                 <option value="en-GB" data-lang-name="English">English (UK)</option>
                                 <option value="es-ES" data-lang-name="Spanish">Español (Spain)</option>
                                 <option value="fr-FR" data-lang-name="French">Français (France)</option>
                                 <option value="de-DE" data-lang-name="German">Deutsch (Germany)</option>
                                 <option value="hi-IN" data-lang-name="Hindi">हिन्दी (India)</option>
                             </select>
                         </div>
                         <div>
                             <h3 class="text-lg font-semibold text-gray-700 mb-3">Commands</h3>
                             <div class="space-y-2 text-sm">
                                 <code class="block bg-gray-100 p-2 rounded-md text-gray-600 w-full text-left">"Add 5 apples"</code>
                                 <code class="block bg-gray-100 p-2 rounded-md text-gray-600 w-full text-left">"Remove apples"</code>
                             </div>
                         </div>
                     </div>
                </section>
            </div>
        </div>
    </main>
    
    <footer class="footer p-6 text-center">
         <p>&copy; 2025 VoiceShop. Made by Gauri Dixit 2201640100149</p>
    </footer>

    <!-- Modals -->
    <div id="features-modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 opacity-0 invisible">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-lg transform -translate-y-10 scale-95">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Features</h2>
                <button class="modal-close-btn text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <ul class="space-y-3 text-gray-600">
                <li class="flex items-start"><strong class="mr-2 text-indigo-600">✓</strong><span><strong>AI-Powered Voice Commands:</strong> Add, remove, and clear items using natural language.</span></li>
                <li class="flex items-start"><strong class="mr-2 text-indigo-600">✓</strong><span><strong>Smart Suggestions:</strong> Get intelligent recommendations based on your current list.</span></li>
                <li class="flex items-start"><strong class="mr-2 text-indigo-600">✓</strong><span><strong>Item Categorization:</strong> Items are automatically grouped by category (e.g., Dairy, Produce).</span></li>
                <li class="flex items-start"><strong class="mr-2 text-indigo-600">✓</strong><span><strong>Multi-Language Support:</strong> Speak in various languages, and the app will understand.</span></li>
                <li class="flex items-start"><strong class="mr-2 text-indigo-600">✓</strong><span><strong>Interactive List:</strong> Check off items as you shop, and they'll be saved for your next visit.</span></li>
            </ul>
        </div>
    </div>
    
    <div id="how-it-works-modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 opacity-0 invisible">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-lg transform -translate-y-10 scale-95">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">How It Works</h2>
                <button class="modal-close-btn text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <ol class="list-decimal list-inside space-y-3 text-gray-600">
                <li><strong>Click the "Speak" Button:</strong> Grant microphone access if prompted. The button will pulse to show it's listening.</li>
                <li><strong>State Your Command:</strong> Speak clearly, e.g., "Add two cartons of milk and a loaf of bread".</li>
                <li><strong>AI Processing:</strong> The app sends your speech to Gemini for analysis. It understands quantities, multiple items, and even categorizes them for you.</li>
                <li><strong>List Updates:</strong> Your list is instantly updated and organized. Smart suggestions will appear based on the items you've added.</li>
            </ol>
        </div>
    </div>

    <div id="faq-modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 opacity-0 invisible">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-lg transform -translate-y-10 scale-95">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Frequently Asked Questions</h2>
                <button class="modal-close-btn text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="space-y-4 text-gray-600">
                <div>
                    <strong class="font-semibold text-gray-800">Do I need to install anything?</strong>
                    <p class="mt-1">No, VoiceShop is a web application that runs directly in your browser. You just need a modern browser (like Chrome or Firefox) and a microphone.</p>
                </div>
                <div>
                    <strong class="font-semibold text-gray-800">Is my shopping list saved?</strong>
                    <p class="mt-1">Yes, your list is automatically saved in your browser's local storage. This means if you close the tab and come back later, your list will still be there on the same device and browser.</p>
                </div>
                 <div>
                    <strong class="font-semibold text-gray-800">What happens if the app doesn't understand me?</strong>
                    <p class="mt-1">Try speaking a bit more clearly or closer to your microphone. Also, ensure you've given the website permission to access your microphone. If the problem persists, try a simpler command like "Add apples".</p>
                </div>
                 <div>
                    <strong class="font-semibold text-gray-800">How does the AI work?</strong>
                    <p class="mt-1">This application uses Google's powerful Gemini model. Your voice command is sent to the AI, which intelligently figures out the action (like adding or removing) and identifies the items and quantities, even if you say them in a complex sentence.</p>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const API_KEY = ''; // IMPORTANT: PASTE YOUR GEMINI API KEY HERE

            const speakBtn = document.getElementById('speak-btn');
            const transcriptEl = document.getElementById('transcript');
            const errorMessageEl = document.getElementById('error-message');
            const listeningIndicator = document.getElementById('listening-indicator');
            const shoppingListEl = document.getElementById('shopping-list');
            const emptyListMsg = document.getElementById('empty-list-msg');
            const clearBtn = document.getElementById('clear-btn');
            const languageSelect = document.getElementById('language-select');
            const suggestionsContainer = document.getElementById('suggestions-container');
            const suggestionsTitle = document.getElementById('suggestions-title');
            const spinner = document.getElementById('spinner');

            const featuresLink = document.getElementById('features-link');
            const howItWorksLink = document.getElementById('how-it-works-link');
            const faqLink = document.getElementById('faq-link');
            const featuresModal = document.getElementById('features-modal');
            const howItWorksModal = document.getElementById('how-it-works-modal');
            const faqModal = document.getElementById('faq-modal');

            let shoppingList = [];

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;

            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = languageSelect.value;
                recognition.interimResults = false;
                
                recognition.onstart = () => {
                    speakBtn.textContent = 'Listening...';
                    speakBtn.disabled = true;
                    speakBtn.classList.add('is-listening');
                    listeningIndicator.classList.remove('hidden');
                    transcriptEl.textContent = '';
                    errorMessageEl.textContent = '';
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    transcriptEl.textContent = `You said: "${transcript}"`;
                    processCommandWithGemini(transcript);
                };

                recognition.onerror = (event) => {
                    errorMessageEl.textContent = `Error: ${event.error}. Please check permissions.`;
                    resetSpeakButton();
                };

                recognition.onend = () => { resetSpeakButton(); };

            } else {
                speakBtn.disabled = true;
                errorMessageEl.textContent = "Sorry, your browser doesn't support speech recognition.";
            }
            
            speakBtn.addEventListener('click', () => {
                if (API_KEY === '' || !API_KEY) {
                    errorMessageEl.textContent = "Please add your Gemini API key in the script to begin.";
                    return;
                }
                if (recognition) {
                    try { recognition.start(); } catch(e) {
                        console.error("Recognition start error:", e);
                        errorMessageEl.textContent = "Error starting recognition. Please try again.";
                        resetSpeakButton();
                    }
                }
            });
            
            languageSelect.addEventListener('change', () => {
                if (recognition) { recognition.lang = languageSelect.value; }
            });
            
            clearBtn.addEventListener('click', async () => {
                shoppingList = [];
                await updateListAndStorage();
            });

            async function callGeminiAPI(prompt, isSuggestion = false) {
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${API_KEY}`;
                
                if (!isSuggestion) { setThinkingState(true); }

                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API error! status: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                    }

                    const data = await response.json();
                    const text = data.candidates[0].content.parts[0].text;
                    return JSON.parse(text.replace(/```json\n|```/g, ''));
                } finally {
                    if (!isSuggestion) { setThinkingState(false); }
                }
            }

            async function processCommandWithGemini(transcript) {
                const languageName = languageSelect.options[languageSelect.selectedIndex].getAttribute('data-lang-name');
                const prompt = `You are a shopping list assistant. Analyze the user's command and convert it to a JSON object. The object should have an 'action' ('add', 'remove', 'clear') and an 'items' array. Each item in the array must be an object with 'name', 'quantity', and a 'category' (e.g., "Produce", "Dairy", "Bakery", "Pantry", "Meat", "Frozen", "Other"). The user is speaking in ${languageName}. Translate item names to English. Command: "${transcript}"`;

                try {
                    const result = await callGeminiAPI(prompt);
                    transcriptEl.textContent = `Processed: "${transcript}"`; 
                    handleAiResponse(result);
                } catch (error) {
                    console.error("Error with Gemini API:", error);
                    errorMessageEl.textContent = "Sorry, I had trouble understanding that.";
                    transcriptEl.textContent = '';
                }
            }
            
            async function handleAiResponse(response) {
                if (!response || !response.action) return;
                const { action, items } = response;
                
                if (action === 'add' && items) {
                    items.forEach(newItem => {
                        if (!newItem.name) return;
                        const existingItem = shoppingList.find(i => i.name.toLowerCase() === newItem.name.toLowerCase());
                        if (existingItem) {
                            existingItem.quantity = (existingItem.quantity || 1) + (newItem.quantity || 1);
                        } else {
                            shoppingList.push({ 
                                name: newItem.name, 
                                quantity: newItem.quantity || 1, 
                                completed: false,
                                category: newItem.category || 'Other' 
                            });
                        }
                    });
                } else if (action === 'remove' && items) {
                    items.forEach(itemToRemove => {
                         if (!itemToRemove.name) return;
                        shoppingList = shoppingList.filter(item => item.name.toLowerCase() !== itemToRemove.name.toLowerCase());
                    });
                } else if (action === 'clear') {
                    shoppingList = [];
                }
                
                await updateListAndStorage();
            }

            function renderShoppingList() {
                shoppingListEl.innerHTML = ''; 

                if (shoppingList.length === 0) {
                    emptyListMsg.classList.remove('hidden');
                    clearBtn.classList.add('hidden');
                } else {
                    emptyListMsg.classList.add('hidden');
                    clearBtn.classList.remove('hidden');

                    const groupedItems = shoppingList.reduce((acc, item) => {
                        const category = item.category || 'Other';
                        if (!acc[category]) {
                            acc[category] = [];
                        }
                        acc[category].push(item);
                        return acc;
                    }, {});

                    const sortedCategories = Object.keys(groupedItems).sort();

                    sortedCategories.forEach(category => {
                        const categoryHeader = document.createElement('h4');
                        categoryHeader.className = 'text-md font-bold text-indigo-700 pt-3 pb-1 border-b-2 border-indigo-100';
                        categoryHeader.textContent = category;
                        shoppingListEl.appendChild(categoryHeader);

                        groupedItems[category].forEach(item => {
                            const itemIndex = shoppingList.indexOf(item);
                            const li = document.createElement('li');
                            li.className = `shopping-list-item flex items-center bg-slate-50 p-3 rounded-lg animate-add-item ${item.completed ? 'completed' : ''}`;
                            
                            li.innerHTML = `
                                <input type="checkbox" id="item-${itemIndex}" data-index="${itemIndex}" class="custom-checkbox mr-4 flex-shrink-0" ${item.completed ? 'checked' : ''}>
                                <label for="item-${itemIndex}" class="flex-grow cursor-pointer flex justify-between items-center">
                                    <div>
                                        <span class="font-medium text-gray-800 item-name">${item.name.charAt(0).toUpperCase() + item.name.slice(1)}</span>
                                        <span class="text-sm text-gray-500 ml-2">(x${item.quantity})</span>
                                    </div>
                                    <span class="text-xs bg-slate-200 text-slate-600 font-semibold px-2 py-1 rounded-full">${item.category}</span>
                                </label>
                                <button data-index="${itemIndex}" class="remove-item-btn text-red-400 hover:text-red-600 font-bold text-2xl px-2 transition-colors flex-shrink-0 ml-2">&times;</button>
                            `;
                            shoppingListEl.appendChild(li);
                        });
                    });
                    
                    document.querySelectorAll('.remove-item-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const index = e.currentTarget.getAttribute('data-index');
                            const li = e.currentTarget.closest('li');
                            li.classList.add('animate-remove-item');
                            li.addEventListener('animationend', async () => {
                                shoppingList.splice(index, 1);
                                await updateListAndStorage();
                            }, { once: true });
                        });
                    });

                    document.querySelectorAll('.custom-checkbox').forEach(checkbox => {
                        checkbox.addEventListener('change', async (e) => {
                           const index = e.currentTarget.getAttribute('data-index');
                           shoppingList[index].completed = e.currentTarget.checked;
                           e.currentTarget.closest('.shopping-list-item').classList.toggle('completed', e.currentTarget.checked);
                           localStorage.setItem('voiceShoppingList', JSON.stringify(shoppingList));
                        });
                    });
                }
            }
            
            async function renderSuggestions() {
                suggestionsContainer.innerHTML = '';
                if (shoppingList.length === 0) {
                    suggestionsTitle.textContent = "Add an item to see AI recommendations!";
                    return;
                }
                
                const currentItems = shoppingList.map(item => item.name).join(', ');
                const prompt = `Based on the shopping list [${currentItems}], suggest 4 relevant grocery items. Do not suggest items already on the list. Return a simple JSON array of strings.`;
                
                try {
                    const suggestions = await callGeminiAPI(prompt, true); 
                    
                    if (suggestions && Array.isArray(suggestions) && suggestions.length > 0) {
                        const nonDuplicateSuggestions = suggestions.filter(s => typeof s === 'string' && !shoppingList.some(i => i.name.toLowerCase() === s.toLowerCase()));
                        if(nonDuplicateSuggestions.length > 0) {
                             suggestionsTitle.textContent = `You might also need:`;
                             nonDuplicateSuggestions.slice(0, 4).forEach(suggestion => {
                                 const button = document.createElement('button');
                                 button.className = 'bg-indigo-100 text-indigo-700 text-sm font-medium px-3 py-1.5 rounded-full hover:bg-indigo-200 transition-colors animate-add-item';
                                 button.textContent = `+ ${suggestion}`;
                                 button.onclick = async () => {
                                     const catPrompt = `Categorize this item: "${suggestion}". Return a JSON object like {"category": "categoryName"}`;
                                     const catResult = await callGeminiAPI(catPrompt, true);
                                     handleAiResponse({ action: 'add', items: [{ name: suggestion, quantity: 1, category: catResult.category }] });
                                 };
                                 suggestionsContainer.appendChild(button);
                             });
                        } else {
                            suggestionsTitle.textContent = "Your list is looking complete!";
                        }
                    } else {
                        suggestionsTitle.textContent = "No specific suggestions right now.";
                    }
                } catch (error) {
                    console.error("Error fetching suggestions:", error);
                    suggestionsTitle.textContent = "Could not fetch AI suggestions.";
                }
            }
            
            function resetSpeakButton() {
                speakBtn.textContent = 'Click to Speak';
                speakBtn.disabled = false;
                speakBtn.classList.remove('is-listening');
                listeningIndicator.classList.add('hidden');
            }

            function setThinkingState(isThinking) {
                document.body.classList.toggle('is-thinking', isThinking);
                spinner.classList.toggle('hidden', !isThinking);
                transcriptEl.textContent = isThinking ? "Thinking..." : transcriptEl.textContent;
            }

            async function updateListAndStorage() {
                renderShoppingList();
                await renderSuggestions();
                localStorage.setItem('voiceShoppingList', JSON.stringify(shoppingList));
            }
            
            async function loadListFromStorage() {
                const storedList = localStorage.getItem('voiceShoppingList');
                if (storedList) {
                    try {
                        shoppingList = JSON.parse(storedList);
                        await updateListAndStorage();
                    } catch (e) {
                        console.error("Could not parse shopping list from localStorage", e);
                        localStorage.removeItem('voiceShoppingList');
                    }
                }
            }

            // Modal Logic
            function setupModals() {
                const openModal = (modal) => {
                    modal.classList.add('is-open');
                    document.body.style.overflow = 'hidden';
                };
                const closeModal = (modal) => {
                    modal.classList.remove('is-open');
                    document.body.style.overflow = '';
                };

                featuresLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    openModal(featuresModal);
                });
                howItWorksLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    openModal(howItWorksModal);
                });
                faqLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    openModal(faqModal);
                });

                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal || e.target.closest('.modal-close-btn')) {
                            closeModal(modal);
                        }
                    });
                });
            }

            await loadListFromStorage();
            setupModals();
        });
    </script>
</body>
</html>
